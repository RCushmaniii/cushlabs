---
import { t } from '../../i18n';

interface Props {
  locale: 'en' | 'es';
}

const { locale } = Astro.props;
const dict = t(locale);

const months = locale === 'es'
  ? ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
  : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

const days = locale === 'es'
  ? ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa']
  : ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
---

<div class="date-picker-container" data-locale={locale}>
  <div class="flex items-center justify-between mb-4">
    <button
      type="button"
      id="prev-month"
      class="p-2 rounded-xl border border-border bg-surface hover:border-cush-orange hover:text-cush-orange transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <h3 id="current-month" class="text-lg font-display font-bold text-foreground" aria-live="polite">&nbsp;</h3>
    <button
      type="button"
      id="next-month"
      class="p-2 rounded-xl border border-border bg-surface hover:border-cush-orange hover:text-cush-orange transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>

  <div class="calendar-grid">
    <div class="grid grid-cols-7 gap-1 mb-2">
      {days.map(day => (
        <div class="text-center text-xs font-display font-semibold uppercase tracking-wider text-muted py-2">
          {day}
        </div>
      ))}
    </div>
    <div id="calendar-days" class="grid grid-cols-7 gap-1"></div>
  </div>
</div>

<script define:vars={{ months }}>
  class DatePicker {
    constructor() {
      this.currentDate = new Date();

      const now = new Date();
      const currentHour = now.getHours();

      if (currentHour >= 18) {
        this.selectedDate = new Date(now);
        this.selectedDate.setDate(now.getDate() + 1);
        this.selectedDate.setHours(0, 0, 0, 0);
      } else {
        this.selectedDate = new Date(now);
        this.selectedDate.setHours(0, 0, 0, 0);
      }

      this.months = months;
      this.init();
    }

    init() {
      this.render();
      this.attachEventListeners();
    }

    attachEventListeners() {
      document.getElementById('prev-month')?.addEventListener('click', () => {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.render();
      });

      document.getElementById('next-month')?.addEventListener('click', () => {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.render();
      });
    }

    render() {
      const year = this.currentDate.getFullYear();
      const month = this.currentDate.getMonth();

      const header = document.getElementById('current-month');
      if (header) {
        header.textContent = `${this.months[month]} ${year}`;
      }

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      const container = document.getElementById('calendar-days');
      if (!container) return;

      container.innerHTML = '';

      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'p-2';
        container.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const isPast = dayDate < today && dayDate.toDateString() !== today.toDateString();
        const isToday = dayDate.toDateString() === today.toDateString();
        const isSelected = this.selectedDate && dayDate.toDateString() === this.selectedDate.toDateString();

        const dayCell = document.createElement('button');
        dayCell.type = 'button';
        dayCell.textContent = String(day);

        let classes = 'p-2 text-center rounded-xl transition-all text-sm font-display font-semibold';

        if (isPast) {
          classes += ' text-muted/40 cursor-not-allowed';
        } else if (isSelected) {
          classes += ' bg-cush-orange text-black cursor-pointer';
        } else {
          classes += ' text-foreground hover:border hover:border-cush-orange cursor-pointer';
        }

        if (isToday && !isSelected) {
          classes += ' ring-2 ring-cush-orange/50';
        }

        dayCell.className = classes;

        if (!isPast) {
          dayCell.addEventListener('click', () => {
            this.selectDate(dayDate);
          });
        } else {
          dayCell.disabled = true;
        }

        container.appendChild(dayCell);
      }
    }

    selectDate(date) {
      this.selectedDate = date;
      this.render();

      const event = new CustomEvent('dateSelected', {
        detail: { date },
        bubbles: true,
      });
      document.dispatchEvent(event);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new DatePicker();
    });
  } else {
    new DatePicker();
  }
</script>

<style>
  .calendar-grid {
    max-width: 100%;
  }

  @media (max-width: 640px) {
    .calendar-grid button {
      font-size: 0.875rem;
      padding: 0.5rem;
    }
  }
</style>
