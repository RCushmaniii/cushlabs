---
import DatePicker from './DatePicker.astro';
import { t } from '../../i18n';
import { API_BASE } from '../../config/api';

interface Props {
  locale: 'en' | 'es';
}

const { locale } = Astro.props;
const dict = t(locale);
const b = dict.booking;
---

<div class="booking-steps-container max-w-4xl mx-auto">
  <!-- Session Info Banner -->
  <div class="rounded-2xl border border-border bg-surface p-6 mb-8">
    <h3 class="text-xl font-display font-bold text-foreground mb-4">
      {b.sessionTitle}
    </h3>
    <div class="space-y-3">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-muted">{b.sessionDuration}</p>
      </div>
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg>
        <p class="text-muted">{b.sessionMeet}</p>
      </div>
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-muted">{b.sessionTimezone}</p>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="flex items-center justify-center mb-12 gap-2">
    <div class="step-indicator active" data-step="1">
      <span class="step-number">1</span>
      <span class="step-label hidden sm:inline">{b.step1}</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="2">
      <span class="step-number">2</span>
      <span class="step-label hidden sm:inline">{b.step2}</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="3">
      <span class="step-number">3</span>
      <span class="step-label hidden sm:inline">{b.step3}</span>
    </div>
  </div>

  <!-- Step 1: Date & Time Selection -->
  <div class="step-content active" data-step="1">
    <div class="rounded-2xl border border-border bg-surface p-6">
      <h2 class="text-2xl font-display font-bold text-foreground mb-2">
        {b.selectDateTime}
      </h2>

      <!-- Selected Date Display -->
      <div class="rounded-xl border-2 border-cush-orange/30 bg-cush-orange/5 p-4 mb-6">
        <p class="text-sm text-muted mb-1">{b.selectedDate}</p>
        <p class="text-2xl font-display font-bold text-foreground" id="selected-date-display-top">
          {b.selectDateBelow}
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <DatePicker locale={locale} />
        </div>

        <div>
          <h3 class="text-lg font-display font-semibold text-foreground mb-4">
            {b.selectTime}
          </h3>
          <div id="time-slots-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Your Details -->
  <div class="step-content" data-step="2">
    <div class="rounded-2xl border border-border bg-surface p-6">
      <h2 class="text-2xl font-display font-bold text-foreground mb-6">
        {b.addDetails}
      </h2>

      <!-- Error Message -->
      <div id="form-error" class="hidden rounded-xl border border-red-300 dark:border-red-800 bg-red-50 dark:bg-red-900/20 p-4 mb-6">
        <p class="text-red-600 dark:text-red-400 text-sm"></p>
      </div>

      <form id="details-form" class="space-y-6 max-w-md mx-auto">
        <div>
          <label for="booking-full-name" class="block text-sm font-display font-semibold text-foreground mb-2">
            {b.fullName}<span class="text-cush-orange">*</span>
          </label>
          <input
            type="text"
            id="booking-full-name"
            name="fullName"
            required
            autocomplete="name"
            class="w-full rounded-xl border border-border bg-base/40 px-4 py-3 text-sm text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange/40"
          />
        </div>

        <div>
          <label for="booking-email" class="block text-sm font-display font-semibold text-foreground mb-2">
            {b.email}<span class="text-cush-orange">*</span>
          </label>
          <input
            type="email"
            id="booking-email"
            name="email"
            required
            autocomplete="email"
            class="w-full rounded-xl border border-border bg-base/40 px-4 py-3 text-sm text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange/40"
          />
        </div>

        <div>
          <label for="booking-phone" class="block text-sm font-display font-semibold text-foreground mb-2">
            {b.phoneNumber}
          </label>
          <input
            type="tel"
            id="booking-phone"
            name="phone"
            autocomplete="tel"
            class="w-full rounded-xl border border-border bg-base/40 px-4 py-3 text-sm text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange/40"
          />
          <p class="text-sm text-muted mt-2">{b.phoneHint}</p>
        </div>

        <div>
          <label for="booking-notes" class="block text-sm font-display font-semibold text-foreground mb-2">
            {b.notesLabel}
          </label>
          <textarea
            id="booking-notes"
            name="notes"
            rows="3"
            placeholder={b.notesPlaceholder}
            class="w-full rounded-xl border border-border bg-base/40 px-4 py-3 text-sm text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange/40 resize-none"
          ></textarea>
          <p class="text-sm text-muted mt-2">{b.notesHint}</p>
        </div>

        <div class="flex gap-4 pt-4">
          <button
            type="button"
            id="back-to-step1"
            class="flex-1 inline-flex items-center justify-center rounded-xl border border-border bg-surface px-6 py-3 text-sm font-display font-semibold text-foreground hover:border-cush-orange hover:text-cush-orange transition-colors"
          >
            {b.back}
          </button>
          <button
            type="button"
            id="confirm-booking"
            class="flex-1 inline-flex items-center justify-center rounded-xl bg-cush-orange px-6 py-3 text-sm font-display font-semibold text-black hover:opacity-90 transition-opacity"
          >
            {b.confirmAppointment}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Success / Booked -->
  <div class="step-content" data-step="3">
    <div class="rounded-2xl border border-border bg-surface p-8">
      <!-- Success Icon -->
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-cush-orange/10 rounded-full mb-4">
          <svg class="w-10 h-10 text-cush-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h2 class="text-3xl font-display font-bold text-foreground mb-3">
          {b.successTitle}
        </h2>
        <p class="text-lg text-muted max-w-2xl mx-auto">
          {b.successMessage}
        </p>
      </div>

      <div class="max-w-lg mx-auto space-y-6">
        <!-- Summary Card -->
        <div class="bg-gradient-to-br from-cush-orange/10 to-cush-orange/5 rounded-xl p-6 space-y-4 border border-cush-orange/20">
          <!-- Date & Time -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-sm font-display font-semibold text-muted">{b.summaryDateTime}</p>
              <p class="text-lg font-display font-bold text-foreground" id="summary-datetime"></p>
              <p class="text-sm text-muted mt-1">{b.summaryTimezone}</p>
            </div>
          </div>

          <div class="border-t border-cush-orange/20"></div>

          <!-- Contact Info -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-sm font-display font-semibold text-muted">{b.summaryDetails}</p>
              <p class="font-display font-bold text-foreground" id="summary-name"></p>
              <p class="text-muted" id="summary-email"></p>
              <p class="text-muted" id="summary-phone"></p>
            </div>
          </div>

          <div class="border-t border-cush-orange/20"></div>

          <!-- Meeting Type -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-cush-orange flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-sm font-display font-semibold text-muted">{b.summaryMeetingType}</p>
              <p class="font-display font-bold text-foreground">{b.summaryMeetingValue}</p>
              <p class="text-sm text-muted mt-1">{b.summaryMeetingHint}</p>
            </div>
          </div>
        </div>

        <!-- How to Prepare -->
        <div class="rounded-xl border-2 border-border p-6">
          <h3 class="text-lg font-display font-bold text-foreground mb-3">
            {b.prepareTitle}
          </h3>
          <p class="text-muted leading-relaxed">
            {b.prepareBody}
          </p>
        </div>

        <!-- Sign-off -->
        <div class="text-center">
          <p class="text-lg text-muted mb-6">
            {b.signOff}
            <br />
            <span class="font-display font-bold text-foreground">Robert</span>
          </p>

          <a
            href={locale === 'en' ? '/' : '/es'}
            class="inline-block text-muted hover:text-cush-orange font-display font-semibold text-sm underline-offset-4 hover:underline transition-colors"
          >
            {b.returnHome}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script
  type="application/json"
  data-booking-config
  is:inline
  set:html={JSON.stringify({ apiBase: API_BASE, locale })}
/>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Read config
    const cfgEl = document.querySelector('[data-booking-config]');
    let API_BASE = '';
    let lang = 'en';
    if (cfgEl?.textContent) {
      try {
        const cfg = JSON.parse(cfgEl.textContent);
        API_BASE = cfg.apiBase || '';
        lang = cfg.locale || 'en';
      } catch { /* use defaults */ }
    }

    // Translation helper for JS-only strings
    const jsStrings: Record<string, Record<string, string>> = {
      loading: { en: 'Loading...', es: 'Cargando...' },
      noSlots: { en: 'No available times.', es: 'No hay horarios disponibles.' },
      errorRequired: { en: 'Please fill in required fields.', es: 'Por favor completa los campos requeridos.' },
      errorDateTime: { en: 'Please select a date and time first.', es: 'Por favor selecciona una fecha y hora primero.' },
      errorGeneric: { en: 'There was an error. Please try again.', es: 'Hubo un error. Por favor intenta de nuevo.' },
      processing: { en: 'Processing...', es: 'Procesando...' },
      confirmAppointment: { en: 'Confirm Appointment', es: 'Confirmar Cita' },
      notProvided: { en: 'Not provided', es: 'No proporcionado' },
    };
    function str(key: string): string {
      return jsStrings[key]?.[lang] || jsStrings[key]?.en || key;
    }

    let currentStep = 1;
    let selectedDate: Date | null = null;
    let selectedTime: string | null = null;
    let formData: { name: string; email: string; phone: string; notes: string } = { name: '', email: '', phone: '', notes: '' };
    let isBooking = false;

    // Auto-select today or tomorrow
    const now = new Date();
    const currentHour = now.getHours();

    if (currentHour >= 18) {
      selectedDate = new Date(now);
      selectedDate.setDate(now.getDate() + 1);
      selectedDate.setHours(0, 0, 0, 0);
    } else {
      selectedDate = new Date(now);
      selectedDate.setHours(0, 0, 0, 0);
    }

    function showStep(step: number) {
      currentStep = step;

      document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        if (index + 1 <= step) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      });

      document.querySelectorAll('.step-content').forEach((content) => {
        content.classList.remove('active');
      });
      document.querySelector(`.step-content[data-step="${step}"]`)?.classList.add('active');
    }

    function updateDateDisplay(date: Date | null) {
      const displayTop = document.getElementById('selected-date-display-top');
      if (displayTop && date) {
        const options: Intl.DateTimeFormatOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        displayTop.textContent = date.toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', options);
      }
    }

    // Listen for date selection from DatePicker
    document.addEventListener('dateSelected', (async (e: CustomEvent) => {
      selectedDate = e.detail.date;
      selectedTime = null;
      updateDateDisplay(selectedDate);
      await fetchAvailableSlots(selectedDate!);
    }) as EventListener);

    async function fetchAvailableSlots(date: Date) {
      const container = document.getElementById('time-slots-container');
      if (!container || !date) return;

      container.innerHTML = `<p class="col-span-full text-center text-muted">${str('loading')}</p>`;

      if (!API_BASE) {
        container.innerHTML = `<p class="col-span-full text-center text-muted">${str('noSlots')}</p>`;
        return;
      }

      try {
        const dateStr = date.toISOString().split('T')[0];
        const response = await fetch(`${API_BASE}/slots/${dateStr}?lang=${lang}`);
        const data = await response.json();

        if (data.ok && data.slots && data.slots.length > 0) {
          renderTimeSlots(data.slots);
        } else {
          container.innerHTML = `<p class="col-span-full text-center text-muted">${str('noSlots')}</p>`;
        }
      } catch {
        container.innerHTML = `<p class="col-span-full text-center text-muted">${str('noSlots')}</p>`;
      }
    }

    function renderTimeSlots(slots: string[]) {
      const container = document.getElementById('time-slots-container');
      if (!container) return;

      container.innerHTML = slots.map((time) => `
        <button
          type="button"
          class="time-slot-btn px-4 py-3 border-2 border-border rounded-xl hover:border-cush-orange transition-all font-display font-semibold text-foreground"
          data-time="${time}"
        >
          ${time}
        </button>
      `).join('');

      container.querySelectorAll('.time-slot-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          selectedTime = target.dataset.time || null;

          container.querySelectorAll('.time-slot-btn').forEach((b) => {
            b.classList.remove('border-cush-orange', 'bg-cush-orange', 'text-black');
            b.classList.add('border-border', 'text-foreground');
          });
          target.classList.add('border-cush-orange', 'bg-cush-orange', 'text-black');
          target.classList.remove('border-border', 'text-foreground');

          // Auto-advance to step 2
          setTimeout(() => showStep(2), 300);
        });
      });
    }

    function showError(message: string) {
      const errorDiv = document.getElementById('form-error');
      if (!errorDiv) return;
      const errorText = errorDiv.querySelector('p');
      if (errorText) errorText.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    // Back button
    document.getElementById('back-to-step1')?.addEventListener('click', () => showStep(1));

    // Confirm booking
    document.getElementById('confirm-booking')?.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopImmediatePropagation();

      const nameInput = document.getElementById('booking-full-name') as HTMLInputElement | null;
      const emailInput = document.getElementById('booking-email') as HTMLInputElement | null;
      const phoneInput = document.getElementById('booking-phone') as HTMLInputElement | null;
      const notesInput = document.getElementById('booking-notes') as HTMLTextAreaElement | null;

      if (!selectedDate || !selectedTime) {
        showError(str('errorDateTime'));
        showStep(1);
        return;
      }

      if (!nameInput?.value || !emailInput?.value) {
        showError(str('errorRequired'));
        return;
      }

      if (isBooking) return;

      isBooking = true;
      const btn = document.getElementById('confirm-booking') as HTMLButtonElement;
      const newBtn = btn.cloneNode(true) as HTMLButtonElement;
      btn.parentNode?.replaceChild(newBtn, btn);
      newBtn.disabled = true;
      newBtn.style.opacity = '0.6';
      newBtn.style.cursor = 'not-allowed';
      newBtn.textContent = str('processing');

      formData = {
        name: nameInput.value,
        email: emailInput.value,
        phone: phoneInput?.value || '',
        notes: notesInput?.value || '',
      };

      try {
        const dateStr = selectedDate.toISOString().split('T')[0];

        const response = await fetch(`${API_BASE}/book`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: formData.name,
            email: formData.email,
            date: dateStr,
            time: selectedTime,
            lang: lang,
            notes: formData.notes || '',
          }),
        });

        const data = await response.json();

        if (data.ok) {
          const dateOptions: Intl.DateTimeFormatOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          const dateStrFormatted = selectedDate.toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', dateOptions);

          const summaryDatetime = document.getElementById('summary-datetime');
          const summaryName = document.getElementById('summary-name');
          const summaryEmail = document.getElementById('summary-email');
          const summaryPhone = document.getElementById('summary-phone');

          if (summaryDatetime) summaryDatetime.textContent = `${dateStrFormatted} - ${selectedTime}`;
          if (summaryName) summaryName.textContent = formData.name;
          if (summaryEmail) summaryEmail.textContent = formData.email;
          if (summaryPhone) summaryPhone.textContent = formData.phone || str('notProvided');

          setTimeout(() => {
            showStep(3);
            document.querySelector('.booking-steps-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } else {
          throw new Error(data.error || 'Booking failed');
        }
      } catch {
        showError(str('errorGeneric'));
        isBooking = false;
        const resetBtn = document.getElementById('confirm-booking') as HTMLButtonElement | null;
        if (resetBtn) {
          resetBtn.disabled = false;
          resetBtn.style.opacity = '1';
          resetBtn.style.cursor = 'pointer';
          resetBtn.textContent = str('confirmAppointment');
        }
        showStep(2);
      }
    });

    // Initialize
    updateDateDisplay(selectedDate);
    fetchAvailableSlots(selectedDate!);
  });
</script>

<style>
  .step-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.5;
    transition: opacity 0.3s;
  }

  .step-indicator.active {
    opacity: 1;
  }

  .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background-color: rgb(var(--border));
    color: rgb(var(--muted));
    font-weight: 600;
    font-size: 0.875rem;
  }

  .step-indicator.active .step-number {
    background-color: #FF6A3D;
    color: #000;
  }

  .step-label {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 600;
    font-size: 0.875rem;
    color: rgb(var(--fg));
  }

  .step-connector {
    width: 3rem;
    height: 2px;
    background-color: rgb(var(--border));
  }

  .step-content {
    display: none;
  }

  .step-content.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 640px) {
    .step-connector {
      width: 1.5rem;
    }
  }
</style>
