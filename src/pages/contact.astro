---
import BaseLayout from "../layouts/BaseLayout.astro";
import Container from "../components/layout/Container.astro";
import { t } from "../i18n";

const locale = (Astro.currentLocale === "es" ? "es" : "en") as "en" | "es";
const dict = t(locale);

const whatsappNumber = "523315590572";
const whatsappMessages = {
  en: "Hi Robert! I found you through CushLabs.ai and had a quick question about a project.",
  es: "Hola Robert! Te encontré en CushLabs.ai y tengo una pregunta sobre un proyecto.",
};
const whatsappLink = `https://api.whatsapp.com/send/?phone=${whatsappNumber}&text=${encodeURIComponent(whatsappMessages[locale])}&type=phone_number&app_absent=0`;

// Email split into parts to defeat bot scrapers — assembled by client-side JS
const emailUser = "info";
const emailDomain = "cushlabs.ai";

const content = {
  en: {
    badge: "Get in Touch",
    headline: "Let's Talk About Your Project",
    subheadline: "Tell me what you're working on. I'll get back to you with honest thoughts and a clear path forward — no pressure, no pitch.",
    ctaPrimary: "Book a Free Call",
    ctaSecondary: "Send a Message",
    reassurance: "Response within 24 hours. Usually faster.",
  },
  es: {
    badge: "Contáctame",
    headline: "Hablemos de Tu Proyecto",
    subheadline: "Cuéntame qué estás construyendo. Te responderé con ideas honestas y un camino claro — sin presión, sin pitch.",
    ctaPrimary: "Agendar Llamada Gratis",
    ctaSecondary: "Enviar Mensaje",
    reassurance: "Respuesta en 24 horas. Usualmente más rápido.",
  },
};

const hero = content[locale];
---

<BaseLayout
  title={`${dict.contact.title} | CushLabs.ai`}
  description={hero.subheadline}
>
  <!-- Hero Section -->
  <section class="relative pt-24 pb-16 overflow-hidden">
    <!-- Background Image (very subtle) -->
    <div class="absolute inset-0 -z-20">
      <img
        src="/images/hero/contact-hero.jpg"
        alt=""
        class="w-full h-full object-cover opacity-[0.12] dark:opacity-[0.08]"
      />
      <div class="absolute inset-0 bg-gradient-to-b from-white/50 via-transparent to-white dark:from-gray-950/50 dark:via-transparent dark:to-gray-950"></div>
    </div>
    <!-- Gradient Orbs -->
    <div class="absolute inset-0 -z-10">
      <div class="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-cush-orange/15 rounded-full blur-[120px]"></div>
      <div class="absolute bottom-1/4 right-1/4 w-[400px] h-[400px] bg-cush-orange/10 rounded-full blur-[100px]"></div>
    </div>

    <Container>
      <div class="text-center max-w-3xl mx-auto">
        <span class="inline-block px-3 py-1 text-xs font-display font-semibold text-cush-orange bg-cush-orange/10 rounded-full mb-4">
          {hero.badge}
        </span>
        <h1 class="font-display text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
          {hero.headline}
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
          {hero.subheadline}
        </p>

        <!-- CTAs -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
          <a
            href={locale === "es" ? "/es/reservar" : "/consultation"}
            class="group inline-flex items-center gap-2 px-6 py-3 bg-cush-orange text-white font-display font-semibold rounded-lg hover:bg-cush-orange/90 transition-all shadow-lg shadow-cush-orange/25"
          >
            {hero.ctaPrimary}
            <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
          <a
            href="#contact-form"
            class="group inline-flex items-center gap-2 px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-display font-semibold rounded-lg hover:border-cush-orange hover:text-cush-orange transition-all"
          >
            {hero.ctaSecondary}
            <svg class="w-5 h-5 group-hover:translate-y-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
            </svg>
          </a>
        </div>

        <!-- Reassurance -->
        <p class="text-sm text-gray-500 dark:text-gray-500">
          {hero.reassurance}
        </p>
      </div>
    </Container>
  </section>

  <main class="pb-24">

    <section id="contact-form" class="mx-auto max-w-7xl px-4 pt-12">
      <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
        <!-- Contact Form (Primary) -->
        <div class="rounded-2xl border border-border bg-surface p-6 md:p-8 lg:order-1">
          <h2 class="font-display text-xl font-bold text-foreground mb-6">
            {locale === "es" ? "Envíame un mensaje" : "Send me a message"}
          </h2>
          <form
            id="contact-form-el"
            class="space-y-4"
            data-locale={locale}
          >
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div>
                <label
                  for="name"
                  class="block text-sm font-display font-semibold text-foreground"
                >
                  {dict.contact.formName}
                  <span class="text-cush-orange">*</span>
                </label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  required
                  class="mt-2 w-full rounded-lg border border-border bg-base/40 px-3 py-2 text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange"
                />
              </div>

              <div>
                <label
                  for="email"
                  class="block text-sm font-display font-semibold text-foreground"
                >
                  {dict.contact.formEmail}
                  <span class="text-cush-orange">*</span>
                </label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  class="mt-2 w-full rounded-lg border border-border bg-base/40 px-3 py-2 text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange"
                />
              </div>
            </div>

            <div>
              <label
                for="phone"
                class="block text-sm font-display font-semibold text-foreground"
              >
                {dict.contact.formPhone}
              </label>
              <input
                id="phone"
                name="phone"
                type="tel"
                placeholder={dict.contact.formPhoneHint}
                class="mt-2 w-full rounded-lg border border-border bg-base/40 px-3 py-2 text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange"
              />
            </div>

            <div>
              <label
                for="message"
                class="block text-sm font-display font-semibold text-foreground"
              >
                {dict.contact.formMessage}
                <span class="text-cush-orange">*</span>
              </label>
              <textarea
                id="message"
                name="message"
                required
                rows={6}
                placeholder={dict.contact.formMessageHint}
                class="mt-2 w-full rounded-lg border border-border bg-base/40 px-3 py-2 text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-cush-orange"
              ></textarea>
            </div>

            <div class="flex items-start gap-3">
              <input
                id="consent"
                name="consent"
                type="checkbox"
                required
                class="mt-1 h-4 w-4 rounded border-border bg-base/40 text-cush-orange focus:ring-cush-orange"
              />
              <label for="consent" class="text-sm text-muted">
                {dict.contact.formConsent}
                <span class="text-cush-orange">*</span>
              </label>
            </div>

            <!-- Error message -->
            <div id="form-error" class="hidden rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3 text-sm text-red-700 dark:text-red-400"></div>

            <div class="pt-2">
              <button
                type="submit"
                id="submit-btn"
                class="inline-flex items-center justify-center gap-2 rounded-lg bg-cush-orange px-6 py-3 text-sm font-display font-semibold text-black hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span id="submit-text">{dict.contact.formSubmit}</span>
                <svg id="submit-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
              </button>
            </div>
          </form>

          <!-- Success message (replaces form) -->
          <div id="form-success" class="hidden text-center py-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 mb-4">
              <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h3 class="font-display text-xl font-bold text-foreground mb-2">
              {locale === "es" ? "Mensaje enviado" : "Message sent"}
            </h3>
            <p class="text-muted">
              {locale === "es"
                ? "Te responderé dentro de 24 horas — usualmente más rápido."
                : "I'll get back to you within 24 hours — usually faster."}
            </p>
          </div>
        </div>

        <!-- Contact Info (Secondary) -->
        <aside class="rounded-2xl border border-border bg-surface p-6 md:p-8 lg:order-2 h-fit">
          <h2 class="font-display text-xl font-bold text-foreground">
            {dict.contact.infoTitle}
          </h2>
          <p class="mt-2 text-muted">{dict.contact.infoSubtitle}</p>

          <div class="mt-6 flex flex-col gap-3">
            <!-- Email button — href assembled by JS to hide from scrapers -->
            <a
              id="email-btn"
              href="#"
              data-u={emailUser}
              data-d={emailDomain}
              data-s={encodeURIComponent("CushLabs Inquiry")}
              class="inline-flex items-center justify-center gap-2 rounded-lg border border-border bg-base/40 px-5 py-3 text-sm font-display font-semibold text-foreground hover:border-cush-orange hover:text-cush-orange transition-colors"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              <span>{dict.contact.sendEmail}</span>
            </a>

            <!-- WhatsApp button -->
            <a
              href={whatsappLink}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 rounded-lg bg-green-600 px-5 py-3 text-sm font-display font-semibold text-white hover:bg-green-700 transition-colors"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              <span>{dict.contact.whatsapp}</span>
            </a>
          </div>

          <dl class="mt-6 space-y-3 text-sm">
            <div class="flex items-start justify-between gap-4">
              <dt class="text-muted">{dict.contact.timezone}</dt>
              <dd class="text-foreground text-right">
                {dict.contact.timezoneValue}
              </dd>
            </div>
            <div class="flex items-start justify-between gap-4">
              <dt class="text-muted">{dict.contact.email}</dt>
              <dd class="text-foreground text-right">
                <span id="email-display"></span>
              </dd>
            </div>
          </dl>

          <div class="mt-6 pt-6 border-t border-border">
            <p class="text-sm text-muted mb-3">
              {locale === "es" ? "¿Prefieres hablar en vivo?" : "Prefer to talk live?"}
            </p>
            <a
              href={locale === "es" ? "/es/reservar" : "/consultation"}
              class="inline-flex items-center gap-2 text-sm font-display font-semibold text-cush-orange hover:opacity-80 transition-opacity"
            >
              {dict.contact.consultation}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Assemble obfuscated email for the sidebar button and display
      const btn = document.getElementById('email-btn') as HTMLAnchorElement | null;
      if (btn) {
        const u = btn.dataset.u;
        const d = btn.dataset.d;
        const s = btn.dataset.s;
        const addr = u + '@' + d;
        btn.href = 'mailto:' + addr + '?subject=' + s;

        const display = document.getElementById('email-display');
        if (display) display.textContent = addr;
      }

      // Contact form — submit via Formspree
      const form = document.getElementById('contact-form-el') as HTMLFormElement | null;
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
        const submitText = document.getElementById('submit-text')!;
        const spinner = document.getElementById('submit-spinner')!;
        const errorEl = document.getElementById('form-error')!;
        const successEl = document.getElementById('form-success')!;

        // Reset error state
        errorEl.classList.add('hidden');

        // Get form values
        const name = (form.querySelector('#name') as HTMLInputElement).value.trim();
        const email = (form.querySelector('#email') as HTMLInputElement).value.trim();
        const phone = (form.querySelector('#phone') as HTMLInputElement).value.trim();
        const message = (form.querySelector('#message') as HTMLTextAreaElement).value.trim();
        const consent = (form.querySelector('#consent') as HTMLInputElement).checked;
        const locale = form.dataset.locale || 'en';

        if (!name || !email || !message || !consent) {
          errorEl.textContent = locale === 'es'
            ? 'Completa los campos requeridos y acepta los términos.'
            : 'Please complete the required fields and accept the terms.';
          errorEl.classList.remove('hidden');
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitText.textContent = locale === 'es' ? 'Enviando...' : 'Sending...';
        spinner.classList.remove('hidden');

        try {
          const res = await fetch('https://formspree.io/f/mlgwnqky', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({
              name,
              email,
              _replyto: email,
              phone: phone || undefined,
              message,
              _subject: `New contact from ${name} — CushLabs.ai`,
              _language: locale,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            const msg = data.errors?.map((e: { message: string }) => e.message).join(', ') || 'Unknown error';
            throw new Error(msg);
          }

          // Success — hide form, show confirmation
          form.classList.add('hidden');
          successEl.classList.remove('hidden');
        } catch (err) {
          errorEl.textContent = locale === 'es'
            ? 'Hubo un error al enviar. Intenta de nuevo o escríbeme por WhatsApp.'
            : 'Something went wrong. Please try again or reach out via WhatsApp.';
          errorEl.classList.remove('hidden');

          // Reset button
          submitBtn.disabled = false;
          submitText.textContent = locale === 'es' ? 'Enviar Mensaje' : 'Send Message';
          spinner.classList.add('hidden');
        }
      });
    });
  </script>
</BaseLayout>
